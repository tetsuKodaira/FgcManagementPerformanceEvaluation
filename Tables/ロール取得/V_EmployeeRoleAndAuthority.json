{"Columns":[{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"varchar","MaxLength":-1,"Name":"employee_z_code","ColumnType":"System.String, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","DatabaseColumnType":"varchar","MaxLength":-1,"Name":"employee_name","ColumnType":"System.String, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","DatabaseColumnType":"varchar","MaxLength":-1,"Name":"primary_exmail_address","ColumnType":"System.String, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"int","MaxLength":-1,"Name":"role_code","ColumnType":"System.Int32, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"nvarchar","MaxLength":-1,"Name":"role_name","ColumnType":"System.String, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"int","MaxLength":-1,"Name":"department_code_lvl00","ColumnType":"System.Int32, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"nvarchar","MaxLength":-1,"Name":"department_name_lvl00","ColumnType":"System.String, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"int","MaxLength":-1,"Name":"department_code_lvl01","ColumnType":"System.Int32, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"nvarchar","MaxLength":-1,"Name":"department_name_lvl01","ColumnType":"System.String, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"int","MaxLength":-1,"Name":"department_code_lvl02","ColumnType":"System.Int32, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"nvarchar","MaxLength":-1,"Name":"department_name_lvl02","ColumnType":"System.String, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"int","MaxLength":-1,"Name":"department_code_lvl03","ColumnType":"System.Int32, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"nvarchar","MaxLength":-1,"Name":"department_name_lvl03","ColumnType":"System.String, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"int","MaxLength":-1,"Name":"department_code_lvl04","ColumnType":"System.Int32, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"nvarchar","MaxLength":-1,"Name":"department_name_lvl04","ColumnType":"System.String, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"int","MaxLength":-1,"Name":"department_code_lvl05","ColumnType":"System.Int32, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"nvarchar","MaxLength":-1,"Name":"department_name_lvl05","ColumnType":"System.String, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"int","MaxLength":-1,"Name":"is_vaild","ColumnType":"System.Int32, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"int","MaxLength":-1,"Name":"department_code_lvl06","ColumnType":"System.Int32, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"nvarchar","MaxLength":-1,"Name":"department_name_lvl06","ColumnType":"System.String, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"varchar","MaxLength":-1,"Name":"division_code","ColumnType":"System.String, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"varchar","MaxLength":-1,"Name":"division_name","ColumnType":"System.String, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"int","MaxLength":-1,"Name":"level_no_lvl00","ColumnType":"System.Int32, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"int","MaxLength":-1,"Name":"office_code","ColumnType":"System.Int32, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"},{"$type":"Forguncy.Model.Tables.BindingColumn, ServerDesignerCommon","Required":true,"DatabaseColumnType":"nvarchar","MaxLength":-1,"Name":"office_name","ColumnType":"System.String, mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"}],"ExternalDatabaseInfo":{"SourceConnectString":"Data Source=NTVMDTEST-006\\SQLEXPRESS;Initial Catalog=ManagementEvaluationDB;Persist Security Info=True;User ID=kodaira;Password=kodaira","CreateViewSql":"\r\n--退職者情報も含まれているため現職の社員のみに絞り込む\r\nWITH employee_department AS(SELECT\r\n\t\t*\r\n\tFROM\r\n\t\t[rds-commondb-poc-zeon-db-001.cjzyjlprofpu.ap-northeast-1.rds.amazonaws.com].[Dev_L_USER_MST].[dbo].[lum_view_employee_department_relations_duplicated] AS employee_department\r\n\tWHERE is_retired = 0\r\n),\r\n--コースコードから対象となる社員を取得\r\nrole_course_relation AS(SELECT\r\n\t\temployee_department.*,\r\n\t\tcourse_role_relation.role_code\r\n\tFROM\r\n\t\temployee_department\r\n\tLEFT OUTER JOIN\r\n\t\tM_role_course_relations AS course_role_relation\r\n\t\tON employee_department.course_code = course_role_relation.course_code\r\n\tLEFT OUTER JOIN\r\n\t--評価部門長のロールの場合被評価者から除外するためのサブクエリ\r\n\t\t(SELECT\r\n\t\t\t\temployee_z_code\r\n\t\t\tFROM\r\n\t\t\t\temployee_department\r\n\t\t\tINNER JOIN\r\n\t\t\t\tM_role_post_relations AS role_post_relation \r\n\t\t\t\tON employee_department.post_code = role_post_relation.post_code\r\n\t\t\tWHERE role_code = 3\r\n\t\t\t) AS is_division_manager\r\n\t\t\tON employee_department.employee_z_code = is_division_manager.employee_z_code\r\n\tWHERE course_role_relation.role_code IS NOT NULL\r\n\tAND ((course_role_relation.role_code = 7 AND employee_department.count_belonging_department = 1) OR course_role_relation.role_code != 7) --被評価者ロールの場合は主所属のみに絞り込み\r\n\tAND is_division_manager.employee_z_code IS NULL --評価部門長の場合は除外\r\n),\r\n--ポストコードから対象となる社員を取得\r\nrole_post_relation AS(SELECT\r\n\t\temployee_department.*,\r\n\t\trole_post_relation.role_code\r\n\tFROM\r\n\t\temployee_department\r\n\tLEFT OUTER JOIN\r\n\t\tM_role_post_relations AS role_post_relation\r\n\t\tON employee_department.post_code = role_post_relation.post_code\r\n\tWHERE role_post_relation.role_code IS NOT NULL\r\n),\r\n--承認者に指定されている社員を取得。プロトで回す中で場合に応じて取得ロジックは見直す\r\nassign_employee AS(SELECT\r\n\t\tLTRIM(FGC_AssignTo) AS employee_z_code, --なぜかスペースついているのでトリム\r\n\t\torganization_code AS department_code,\r\n\t\t8 AS role_code\r\n\tFROM\r\n\t\tT_BasicInformation AS basicinformation\r\n\tWHERE new_flag\t = 1 --最新の業績評価表のみに絞り込み\r\n\tAND employee_z_code != FGC_AssignTo --起票者は除く\r\n),\r\n--個別に追加された社員を取得\r\naddional_employee AS (\r\n\tSELECT\r\n\t\t\temployee_z_code,\r\n\t\t\trole_code,\r\n\t\t\tdepartment_code\r\n\tFROM\r\n\t\tM_role_addtional_employees AS role_addtional_employee\r\n)\r\nSELECT \r\n\temployee.account_code AS employee_z_code,\r\n\temployee.account_display_name AS employee_name,\r\n\temployee.primary_exmail_address,\r\n\trole.role_code,\r\n\trole.role_name,\r\n\tdepartment.*\r\nFROM\r\n\t--社員、所属、ロールの組み合わせで一意にする\r\n\t(SELECT\r\n\t\t\temployee_z_code,\r\n\t\t\tdepartment_code,\r\n\t\t\trole_code\r\n\t\tFROM\r\n\t\t\t--WITHのサブクエリで取得した社員を統合させる\r\n\t\t\t(SELECT \r\n\t\t\t\temployee_z_code,\r\n\t\t\t\tdepartment_code_lvl00 AS department_code,\r\n\t\t\t\trole_code\r\n\t\t\tFROM\r\n\t\t\t\trole_course_relation\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT\r\n\t\t\t\temployee_z_code,\r\n\t\t\t\tdepartment_code_lvl00,\r\n\t\t\t\trole_code\r\n\t\t\tFROM\r\n\t\t\t\trole_post_relation\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT\r\n\t\t\t\temployee_z_code,\r\n\t\t\t\tdepartment_code,\r\n\t\t\t\trole_code\r\n\t\t\tFROM\r\n\t\t\t\taddional_employee\r\n\t\t\tUNION ALL\r\n\t\t\tSELECT\r\n\t\t\t\temployee_z_code,\r\n\t\t\t\tdepartment_code,\r\n\t\t\t\trole_code\r\n\t\t\tFROM\r\n\t\t\t\tassign_employee\r\n\t\t\t) AS role_relation\r\n\t\tGROUP BY employee_z_code,department_code,role_code\r\n\t) AS employee_department_role\r\nINNER JOIN\r\n\tM_roles AS role\r\n\tON employee_department_role.role_code = role.role_code\r\nINNER JOIN\r\n\t[rds-commondb-poc-zeon-db-001.cjzyjlprofpu.ap-northeast-1.rds.amazonaws.com].[Dev_L_USER_MST].[dbo].[lum_view_departments_duplicated] AS department\r\n\tON employee_department_role.department_code = department.department_code_lvl00\r\nINNER JOIN\r\n\t[rds-commondb-poc-zeon-db-001.cjzyjlprofpu.ap-northeast-1.rds.amazonaws.com].[EMP_MST].[dbo].[NAC_Acc_Account] AS employee\r\n\tON employee.account_code = employee_department_role.employee_z_code\r\n","SourceTableName":"V_EmployeeRoleAndAuthority","SourceTableSchema":"dbo","DataBaseType":1,"ViewInfo":{"ViewName":"V_EmployeeRoleAndAuthority","IsUpdatable":true,"QueryColumns":[]},"UserSetQueryColumns":[]},"Name":"V_EmployeeRoleAndAuthority","Relations":[]}